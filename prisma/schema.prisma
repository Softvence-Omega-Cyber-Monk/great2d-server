// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId                    String   @id @default(uuid())
  email                     String   @unique
  fullName                  String?
  password                  String
  phone                     String?
  profilePictureUrl         String?
  role                      UserRole @default(user)
  isDarkMode                Boolean  @default(false)
  isNotificationsEnabled    Boolean  @default(true)
  isUsingBiometrics         Boolean  @default(false)
  isDeleted                 Boolean  @default(false)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  fcmToken                  String?
  monthlySavingsGoal        Float?    @default(0)
  passwordResets            PasswordReset[]

  //Relations
  paymentMethods            PaymentMethod[]
  subscriptions             Subscription[]
  bills                     Bill[]
  billTrackings             BillTracking[]
  paypalPayments            PayPalPayment[]
  notifications             Notification[]
}

model Notification {
  id                        String              @id @default(uuid())
  userId                    String
  title                     String
  body                      String
  type                      NotificationType    @default(general)
  isRead                    Boolean             @default(false)
  
  // Related entity references
  billId                    String?
  
  // Additional data stored as JSON
  data                      Json?
  
  createdAt                 DateTime            @default(now())
  readAt                    DateTime?
  
  // Relations
  user                      User                @relation(fields: [userId], references: [userId], onDelete: Cascade)
  bill                      Bill?               @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Bill {
  id                        String        @id @default(uuid())
  userId                    String
  
  // Provider information stored directly in bill
  providerEmail             String
  providerName              String?
  category                  BillCategory  @default(other)
  
  accountDetails            String?       // Account number or other identifying details
  negotiationRecommendation String?       // AI-generated recommendation
  emailSubject              String?
  emailBody                 String?       @db.Text
  emailThreadId             String?       // Gmail thread ID
  emailMessageId            String?       // Gmail message ID
  status                    BillStatus    @default(draft)
  sentAt                    DateTime?

  actualAmount              Int?
  negotiatedAmount          Int?     
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt
  
  //Relations
  user                      User          @relation(fields: [userId], references: [userId], onDelete: Cascade)
  billTrackings             BillTracking[]
  notifications             Notification[]

  @@index([userId])
  @@index([providerEmail])
  @@index([status])
  @@index([category])
  @@map("bills")
}

model PaymentMethod {
  paymentId                 String   @id @default(uuid())
  userId                    String
  cardHolderName            String
  cardNumber                String
  expiryDate                String
  cvv                       String
  isDefault                 Boolean  @default(false)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  //Relations
  user              User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model SubscriptionPlan {
  subscriptionPlanId        String   @id @default(uuid())
  description               String
  planName                  String
  price                     Float
  duration                  Int      // Duration in months
  features                  String[]
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  //Relations
  subscriptions             Subscription[]
}

model Subscription {
  subscriptionId            String   @id @default(uuid())
  userId                    String
  subscriptionPlanId        String
  transactionId             String   @unique
  startDate                 DateTime
  expiresAt                 DateTime
  isActive                  Boolean  @default(true)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  //Relations
  user                      User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  subscriptionPlan          SubscriptionPlan @relation(fields: [subscriptionPlanId], references: [subscriptionPlanId])
  paypalPayments            PayPalPayment[]

  @@index([userId])
  @@index([subscriptionPlanId])
}

model PasswordReset {
  resetId   String   @id @default(uuid())
  userId    String
  code      String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  
  @@index([userId])
  @@index([code])
  @@map("password_resets")
}

model BillTracking {
  id            String              @id @default(uuid())
  billId        String
  month         DateTime            // Stores the first day of the month (e.g., 2024-01-01)
  billName      String
  category      BillCategory
  provider      String
  amount        Float
  dueDate       DateTime
  paymentStatus BillPaymentStatus   @default(due)
  paidAt        DateTime?
  userId        String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  //Relations
  bill          Bill                @relation(fields: [billId], references: [id], onDelete: Cascade)
  user          User                @relation(fields: [userId], references: [userId], onDelete: Cascade)
  paypalPayments PayPalPayment[]
  
  @@unique([billId, month])
  @@index([userId])
  @@index([month])
  @@index([paymentStatus])
  @@map("bill_tracking")
}

enum BillPaymentStatus {
  due
  paid
  overdue
}

model PayPalPayment {
  id                String              @id @default(uuid())
  userId            String
  paypalOrderId     String              @unique
  paypalPaymentId   String?             @unique
  amount            Float
  currency          String              @default("USD")
  status            PayPalPaymentStatus @default(pending)
  subscriptionName  String?
  description       String?
  payerEmail        String?
  payerName         String?
  payerId           String?
  
  // Related entities (optional)
  billTrackingId    String?
  subscriptionId    String?
  
  // Metadata
  paypalResponse    Json?
  errorMessage      String?
  refundId          String?
  refundedAt        DateTime?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Relations
  user              User                @relation(fields: [userId], references: [userId], onDelete: Cascade)
  billTracking      BillTracking?       @relation(fields: [billTrackingId], references: [id])
  subscription      Subscription?       @relation(fields: [subscriptionId], references: [subscriptionId])
  
  @@index([userId])
  @@index([status])
  @@index([paypalOrderId])
  @@map("paypal_payments")
}

enum PayPalPaymentStatus {
  pending
  completed
  failed
  refunded
  cancelled
}

enum UserRole {
  user
  admin
}

enum BillCategory {
  internet
  electricity
  water
  mobile
  gas
  other
}

enum BillStatus {
  draft          // Email not sent yet
  sent           // Email sent, awaiting response
  negotiating    // In active negotiation
  successful     // Successfully negotiated
  failed         // Negotiation failed
  cancelled      // User cancelled
}

enum NotificationType {
  bill_status_change
  payment_reminder
  savings_milestone
  general
  system
}